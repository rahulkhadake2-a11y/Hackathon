<div class="risk-analysis-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="bi bi-shield-exclamation"></i>
        AI Risk Analysis
      </h1>
      <p class="page-subtitle">
        Intelligent vendor risk assessment powered by AI
      </p>
    </div>
    <div class="header-actions">
      <!-- View Mode Toggle -->
      <div class="view-mode-toggle">
        <button 
          class="view-btn" 
          [class.active]="viewMode === 'vendor'"
          (click)="setViewMode('vendor')"
        >
          <i class="bi bi-building"></i> Vendor Analysis
        </button>
        <button 
          class="view-btn" 
          [class.active]="viewMode === 'items'"
          (click)="setViewMode('items')"
        >
          <i class="bi bi-box-seam"></i> Item Analysis
        </button>
      </div>

      <!-- Provider Selection (only show for vendor analysis) -->
      <div class="provider-selector" *ngIf="viewMode === 'vendor'">
        <button 
          class="provider-btn" 
          [class.active]="currentProvider === 'local'"
          (click)="setProvider('local')"
          title="Works offline, no API needed"
        >
          <i class="bi bi-cpu"></i> Local
        </button>
        <button
          class="provider-btn gemini"
          [class.active]="currentProvider === 'gemini'"
          (click)="setProvider('gemini')"
          title="Google Gemini - FREE!"
        >
          <i class="bi bi-stars"></i> Gemini (Free)
        </button>
        <button
          class="provider-btn"
          [class.active]="currentProvider === 'openai'"
          (click)="setProvider('openai')"
          title="OpenAI - Requires credits"
        >
          <i class="bi bi-lightning"></i> OpenAI
        </button>
      </div>
      
      <button class="btn btn-outline-primary" (click)="showApiKeyModal = true" *ngIf="viewMode === 'vendor'">
        <i class="bi bi-key"></i>
        Configure AI
      </button>
    </div>
  </div>

  <!-- VENDOR ANALYSIS VIEW -->
  <div class="content-grid" *ngIf="viewMode === 'vendor'">
    <!-- Vendor Selection Panel -->
    <div class="vendor-panel">
      <div class="panel-header">
        <h3><i class="bi bi-building"></i> Select Vendor</h3>
      </div>
      <div class="vendor-list">
        <!-- Loading State -->
        <div class="loading-state" *ngIf="isLoadingVendors">
          <div class="spinner"></div>
          <p>Loading vendors from API...</p>
        </div>

        <!-- Empty State -->
        <div
          class="empty-vendors"
          *ngIf="!isLoadingVendors && vendors.length === 0"
        >
          <i class="bi bi-inbox"></i>
          <p>No vendors found. Add vendors in the Vendor Management section.</p>
        </div>

        <!-- Vendor List -->
        <div
          *ngFor="let vendor of vendors"
          class="vendor-card"
          [class.selected]="selectedVendor?.id === vendor.id"
          (click)="selectVendor(vendor)"
        >
          <div class="vendor-avatar">
            {{ vendor.name.charAt(0) || '?' }}
          </div>
          <div class="vendor-info">
            <h4>{{ vendor.name || "Unknown Vendor" }}</h4>
            <span class="vendor-category">{{
              vendor.category || "Uncategorized"
            }}</span>
          </div>
          <div
            class="vendor-status"
            [ngClass]="vendor.complianceStatus || 'pending-review'"
          >
            <span class="status-dot"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Analysis Panel -->
    <div class="analysis-panel">
      <!-- No Vendor Selected State -->
      <div class="empty-state" *ngIf="!selectedVendor">
        <div class="empty-icon">
          <i class="bi bi-arrow-left-circle"></i>
        </div>
        <h3>Select a Vendor</h3>
        <p>Choose a vendor from the list to begin risk analysis</p>
      </div>

      <!-- Vendor Selected -->
      <div class="analysis-content" *ngIf="selectedVendor">
        <!-- Error Message -->
        <div class="error-alert" *ngIf="errorMessage">
          <i class="bi bi-exclamation-triangle"></i>
          <span>{{ errorMessage }}</span>
          <button class="close-error" (click)="errorMessage = ''">
            <i class="bi bi-x"></i>
          </button>
        </div>

        <!-- Vendor Header -->
        <div class="vendor-header">
          <div class="vendor-title">
            <div class="vendor-logo">{{ selectedVendor.name.charAt(0) || '?' }}</div>
            <div class="vendor-details">
              <h2>{{ selectedVendor.name || "Unknown Vendor" }}</h2>
              <div class="vendor-meta">
                <span
                  ><i class="bi bi-tag"></i>
                  {{ selectedVendor.category || "Uncategorized" }}</span
                >
                <span
                  ><i class="bi bi-calendar"></i> Since
                  {{ formatDate(selectedVendor.createdAt) }}</span
                >
              </div>
            </div>
          </div>
          <button
            class="btn btn-primary analyze-btn"
            (click)="runRiskAnalysis()"
            [disabled]="isAnalyzing"
          >
            <span *ngIf="!isAnalyzing">
              <i class="bi bi-cpu"></i> Run AI Analysis
            </span>
            <span *ngIf="isAnalyzing" class="analyzing">
              <div class="spinner"></div>
              Analyzing...
            </span>
          </button>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
          <div class="stat-card">
            <div class="stat-icon blue">
              <i class="bi bi-currency-dollar"></i>
            </div>
            <div class="stat-content">
              <span class="stat-value">{{
                formatCurrency(selectedVendor.totalPurchases)
              }}</span>
              <span class="stat-label">Total Purchases</span>
            </div>
          </div>
          <div class="stat-card">
            <div
              class="stat-icon"
              [ngClass]="{
                green: selectedVendor.onTimeDeliveryRate >= 90,
                orange:
                  selectedVendor.onTimeDeliveryRate >= 70 &&
                  selectedVendor.onTimeDeliveryRate < 90,
                red: selectedVendor.onTimeDeliveryRate < 70
              }"
            >
              <i class="bi bi-truck"></i>
            </div>
            <div class="stat-content">
              <span class="stat-value"
                >{{ selectedVendor.onTimeDeliveryRate }}%</span
              >
              <span class="stat-label">On-Time Delivery</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" [ngClass]="{'green': selectedVendor.qualityScore >= 80, 'orange': selectedVendor.qualityScore >= 60 && selectedVendor.qualityScore < 80, 'red': selectedVendor.qualityScore < 60}">
              <i class="bi bi-star"></i>
            </div>
            <div class="stat-content">
              <span class="stat-value"
                >{{ selectedVendor.qualityScore }}/100</span
              >
              <span class="stat-label">Quality Score</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" [ngClass]="selectedVendor.complianceStatus">
              <i class="bi bi-shield-check"></i>
            </div>
            <div class="stat-content">
              <span class="stat-value capitalize">{{
                selectedVendor.complianceStatus
              }}</span>
              <span class="stat-label">Compliance</span>
            </div>
          </div>
        </div>

        <!-- Analysis Results -->
        <div class="analysis-results" *ngIf="currentAssessment">
          <!-- Risk Score Overview -->
          <div class="risk-overview">
            <div
              class="risk-score-card"
              [ngClass]="getRiskLevelClass(currentAssessment.riskLevel)"
            >
              <div class="score-circle">
                <svg viewBox="0 0 100 100">
                  <circle class="score-bg" cx="50" cy="50" r="45"></circle>
                  <circle
                    class="score-progress"
                    cx="50"
                    cy="50"
                    r="45"
                    [style.stroke]="
                      getRiskScoreColor(currentAssessment.overallRiskScore)
                    "
                    [style.stroke-dasharray]="
                      currentAssessment.overallRiskScore * 2.83 + ' 283'
                    "
                  ></circle>
                </svg>
                <div class="score-value">
                  <span class="score-number">{{
                    currentAssessment.overallRiskScore
                  }}</span>
                  <span class="score-max">/100</span>
                </div>
              </div>
              <div class="score-info">
                <h3>Overall Risk Score</h3>
                <span
                  class="risk-badge"
                  [ngClass]="getRiskLevelClass(currentAssessment.riskLevel)"
                >
                  {{ currentAssessment.riskLevel | uppercase }} RISK
                </span>
                <p class="score-date">
                  Assessed on {{ formatDate(currentAssessment.assessmentDate) }}
                </p>
              </div>
            </div>

            <!-- Peer Comparison -->
            <div
              class="peer-comparison"
              *ngIf="currentAssessment.comparisonToPeers"
            >
              <h4><i class="bi bi-people"></i> Peer Comparison</h4>
              <div class="comparison-stat">
                <span class="label">Industry Average</span>
                <span class="value"
                  >{{
                    currentAssessment.comparisonToPeers.averageRiskScore
                  }}/100</span
                >
              </div>
              <div class="comparison-stat">
                <span class="label">Percentile</span>
                <span
                  class="value"
                  [class.good]="
                    currentAssessment.comparisonToPeers.betterThanPeers
                  "
                >
                  {{ currentAssessment.comparisonToPeers.percentile }}%
                </span>
              </div>
              <div
                class="comparison-badge"
                [class.positive]="
                  currentAssessment.comparisonToPeers.betterThanPeers
                "
              >
                <i
                  class="bi"
                  [ngClass]="
                    currentAssessment.comparisonToPeers.betterThanPeers
                      ? 'bi-arrow-up'
                      : 'bi-arrow-down'
                  "
                ></i>
                {{
                  currentAssessment.comparisonToPeers.betterThanPeers
                    ? "Better"
                    : "Worse"
                }}
                than peers
              </div>
            </div>
          </div>

          <!-- Tabs -->
          <div class="analysis-tabs">
            <button
              class="tab-btn"
              [class.active]="activeTab === 'overview'"
              (click)="activeTab = 'overview'"
            >
              <i class="bi bi-grid"></i> Overview
            </button>
            <button
              class="tab-btn"
              [class.active]="activeTab === 'factors'"
              (click)="activeTab = 'factors'"
            >
              <i class="bi bi-list-check"></i> Risk Factors
            </button>
            <button
              class="tab-btn"
              [class.active]="activeTab === 'insights'"
              (click)="activeTab = 'insights'"
            >
              <i class="bi bi-lightbulb"></i> AI Insights
            </button>
            <button
              class="tab-btn"
              [class.active]="activeTab === 'chat'"
              (click)="activeTab = 'chat'"
            >
              <i class="bi bi-chat-dots"></i> Ask AI
            </button>
          </div>

          <!-- Tab Content -->
          <div class="tab-content">
            <!-- Overview Tab -->
            <div class="tab-pane" *ngIf="activeTab === 'overview'">
              <div class="recommendations-section">
                <h4><i class="bi bi-clipboard-check"></i> Recommendations</h4>
                <ul
                  class="recommendations-list"
                  *ngIf="
                    currentAssessment.recommendations &&
                    currentAssessment.recommendations.length > 0
                  "
                >
                  <li
                    *ngFor="
                      let rec of currentAssessment.recommendations;
                      let i = index
                    "
                  >
                    <span class="rec-number">{{ i + 1 }}</span>
                    <span class="rec-text">{{ rec }}</span>
                  </li>
                </ul>
                <div
                  class="empty-tab"
                  *ngIf="
                    !currentAssessment.recommendations ||
                    currentAssessment.recommendations.length === 0
                  "
                >
                  <i class="bi bi-clipboard"></i>
                  <p>No recommendations available.</p>
                </div>
              </div>

              <!-- Risk Trend -->
              <div
                class="trend-section"
                *ngIf="currentAssessment.historicalTrend.length > 0"
              >
                <h4><i class="bi bi-graph-up"></i> Risk Trend</h4>
                <div class="trend-chart">
                  <div
                    class="trend-bar"
                    *ngFor="let point of currentAssessment.historicalTrend"
                    [style.height.%]="point.riskScore"
                    [ngClass]="getRiskLevelClass(point.riskLevel)"
                    [title]="formatDate(point.date) + ': ' + point.riskScore"
                  >
                    <span class="trend-value">{{ point.riskScore }}</span>
                  </div>
                </div>
                <div class="trend-labels">
                  <span *ngFor="let point of currentAssessment.historicalTrend">
                    {{ formatDate(point.date).split(" ")[0] }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Risk Factors Tab -->
            <div class="tab-pane" *ngIf="activeTab === 'factors'">
              <div
                class="factors-grid"
                *ngIf="
                  currentAssessment.riskFactors &&
                  currentAssessment.riskFactors.length > 0
                "
              >
                <div
                  class="factor-card"
                  *ngFor="let factor of currentAssessment.riskFactors"
                  [ngClass]="getRiskLevelClass(factor.severity)"
                >
                  <div class="factor-header">
                    <div class="factor-icon">
                      <i
                        class="bi"
                        [ngClass]="getCategoryIcon(factor.category)"
                      ></i>
                    </div>
                    <div class="factor-title">
                      <h5>{{ factor.name }}</h5>
                      <span class="factor-category">{{
                        factor.category | titlecase
                      }}</span>
                    </div>
                    <div class="factor-score">
                      <span class="score">{{
                        factor.score | number : "1.0-0"
                      }}</span>
                      <span
                        class="severity-badge"
                        [ngClass]="getRiskLevelClass(factor.severity)"
                      >
                        {{ factor.severity }}
                      </span>
                    </div>
                  </div>
                  <p class="factor-description">{{ factor.description }}</p>
                  <div
                    class="factor-recommendation"
                    *ngIf="factor.recommendation"
                  >
                    <i class="bi bi-lightbulb"></i>
                    <span>{{ factor.recommendation }}</span>
                  </div>
                </div>
              </div>
              <div
                class="empty-tab"
                *ngIf="
                  !currentAssessment.riskFactors ||
                  currentAssessment.riskFactors.length === 0
                "
              >
                <i class="bi bi-exclamation-circle"></i>
                <p>No risk factors found. Try running the analysis again.</p>
              </div>
            </div>

            <!-- AI Insights Tab -->
            <div class="tab-pane" *ngIf="activeTab === 'insights'">
              <div
                class="insights-list"
                *ngIf="
                  currentAssessment.aiInsights &&
                  currentAssessment.aiInsights.length > 0
                "
              >
                <div
                  class="insight-card"
                  *ngFor="let insight of currentAssessment.aiInsights"
                  [ngClass]="getImpactClass(insight.impact)"
                >
                  <div class="insight-header">
                    <div
                      class="insight-icon"
                      [ngClass]="getImpactClass(insight.impact)"
                    >
                      <i
                        class="bi"
                        [ngClass]="{
                          'bi-check-circle': insight.impact === 'positive',
                          'bi-exclamation-triangle':
                            insight.impact === 'negative',
                          'bi-info-circle': insight.impact === 'neutral'
                        }"
                      ></i>
                    </div>
                    <div class="insight-title">
                      <h5>{{ insight.title }}</h5>
                      <div class="insight-meta">
                        <span class="confidence">
                          <i class="bi bi-cpu"></i>
                          {{ (insight.confidence * 100).toFixed(0) }}%
                          confidence
                        </span>
                        <span
                          class="action-badge"
                          *ngIf="insight.actionRequired"
                        >
                          <i class="bi bi-flag"></i> Action Required
                        </span>
                      </div>
                    </div>
                  </div>
                  <p class="insight-description">{{ insight.description }}</p>
                  <div
                    class="insight-actions"
                    *ngIf="
                      insight.suggestedActions &&
                      insight.suggestedActions.length > 0
                    "
                  >
                    <h6>Suggested Actions:</h6>
                    <ul>
                      <li *ngFor="let action of insight.suggestedActions">
                        {{ action }}
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              <div
                class="empty-tab"
                *ngIf="
                  !currentAssessment.aiInsights ||
                  currentAssessment.aiInsights.length === 0
                "
              >
                <i class="bi bi-lightbulb"></i>
                <p>No AI insights available. Try running the analysis again.</p>
              </div>
            </div>

            <!-- Chat Tab -->
            <div class="tab-pane chat-pane" *ngIf="activeTab === 'chat'">
              <div class="chat-container">
                <div class="chat-messages">
                  <div class="chat-welcome" *ngIf="chatMessages.length === 0">
                    <div class="welcome-icon">
                      <i class="bi bi-robot"></i>
                    </div>
                    <h4>AI Risk Assistant</h4>
                    <p>
                      Ask me anything about this vendor's risk assessment,
                      recommendations, or how to mitigate specific risks.
                    </p>
                    <div class="suggested-questions">
                      <button
                        (click)="
                          chatInput = 'What is the overall risk score?';
                          sendChatMessage()
                        "
                      >
                        What is the risk score?
                      </button>
                      <button
                        (click)="
                          chatInput = 'What are the main recommendations?';
                          sendChatMessage()
                        "
                      >
                        Main recommendations?
                      </button>
                      <button
                        (click)="
                          chatInput = 'Tell me about compliance status';
                          sendChatMessage()
                        "
                      >
                        Compliance status
                      </button>
                    </div>
                  </div>

                  <div
                    class="chat-message"
                    *ngFor="let message of chatMessages"
                    [ngClass]="message.role"
                  >
                    <div class="message-avatar">
                      <i
                        class="bi"
                        [ngClass]="
                          message.role === 'user' ? 'bi-person' : 'bi-robot'
                        "
                      ></i>
                    </div>
                    <div class="message-content">
                      <div class="message-text">{{ message.content }}</div>
                      <div class="message-time">
                        {{ formatDate(message.timestamp) }}
                      </div>
                    </div>
                  </div>

                  <div class="typing-indicator" *ngIf="isChatting">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                </div>

                <div class="chat-input-container">
                  <input
                    type="text"
                    class="chat-input"
                    [(ngModel)]="chatInput"
                    placeholder="Ask about vendor risks..."
                    (keyup.enter)="sendChatMessage()"
                    [disabled]="isChatting"
                  />
                  <button
                    class="send-btn"
                    (click)="sendChatMessage()"
                    [disabled]="!chatInput.trim() || isChatting"
                  >
                    <i class="bi bi-send"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- No Assessment State -->
        <div class="no-assessment" *ngIf="!currentAssessment && !isAnalyzing">
          <div class="no-assessment-icon">
            <i class="bi bi-cpu"></i>
          </div>
          <h3>Ready for Analysis</h3>
          <p>
            Click "Run AI Analysis" to generate a comprehensive risk assessment
            for this vendor.
          </p>
        </div>

        <!-- Analyzing State -->
        <div class="analyzing-state" *ngIf="isAnalyzing">
          <div class="analyzing-animation">
            <div class="pulse-ring"></div>
            <div class="pulse-ring delay-1"></div>
            <div class="pulse-ring delay-2"></div>
            <i class="bi bi-cpu"></i>
          </div>
          <h3>Analyzing Vendor Risk</h3>
          <p>
            Our AI is evaluating financial, operational, compliance, and supply
            chain factors...
          </p>
          <div class="analysis-steps">
            <div class="step active">
              <i class="bi bi-check-circle-fill"></i>
              <span>Collecting data</span>
            </div>
            <div class="step active">
              <i class="bi bi-arrow-repeat spin"></i>
              <span>Processing metrics</span>
            </div>
            <div class="step">
              <i class="bi bi-circle"></i>
              <span>Generating insights</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ITEM ANALYSIS VIEW -->
  <div class="item-analysis-container" *ngIf="viewMode === 'items'">
    <!-- Item Analysis Header -->
    <div class="item-analysis-header">
      <div class="header-info">
        <h2><i class="bi bi-box-seam"></i> AI Item Risk Analysis</h2>
        <p>AI-powered item analysis with best-performing items ranked at the top</p>
      </div>
      <div class="header-controls">
        <!-- Provider Selector for Items -->
        <div class="provider-selector-inline">
          <button 
            class="provider-btn-sm" 
            [class.active]="currentProvider === 'local'"
            (click)="setProvider('local')"
            title="Works offline"
          >
            <i class="bi bi-cpu"></i> Local
          </button>
          <button
            class="provider-btn-sm gemini"
            [class.active]="currentProvider === 'gemini'"
            (click)="setProvider('gemini')"
            title="Google Gemini - FREE!"
          >
            <i class="bi bi-stars"></i> Gemini
          </button>
          <button
            class="provider-btn-sm"
            [class.active]="currentProvider === 'openai'"
            (click)="setProvider('openai')"
            title="OpenAI"
          >
            <i class="bi bi-lightning"></i> OpenAI
          </button>
        </div>
        <div class="search-box">
          <i class="bi bi-search"></i>
          <input 
            type="text" 
            placeholder="Search items or vendors..." 
            [(ngModel)]="itemSearchQuery"
            (input)="filterItems()"
          />
        </div>
        <div class="sort-select">
          <label>Sort by:</label>
          <select [(ngModel)]="itemSortBy" (change)="sortItems()">
            <option value="score">AI Score (Best First)</option>
            <option value="risk">Risk (Lowest First)</option>
            <option value="name">Item Name</option>
            <option value="purchases">Most Purchased</option>
            <option value="savings">Potential Savings</option>
          </select>
        </div>
        <button class="btn btn-outline-primary btn-sm" (click)="showApiKeyModal = true">
          <i class="bi bi-key"></i> Configure AI
        </button>
      </div>
    </div>

    <!-- AI Analysis Controls -->
    <div class="ai-analysis-controls" *ngIf="!isLoadingItems && filteredItemAnalysis.length > 0">
      <button 
        class="btn btn-primary ai-analyze-btn"
        (click)="runItemAIAnalysis()"
        [disabled]="isAnalyzingItems"
      >
        <span *ngIf="!isAnalyzingItems">
          <i class="bi bi-cpu"></i> Run AI Analysis on Items
        </span>
        <span *ngIf="isAnalyzingItems" class="analyzing">
          <div class="spinner-sm"></div>
          Analyzing... {{ itemAnalysisProgress }}%
        </span>
      </button>
      <div class="analysis-progress" *ngIf="isAnalyzingItems">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="itemAnalysisProgress"></div>
        </div>
        <span class="progress-text">Analyzing items with AI ({{ itemAnalysisProgress }}%)</span>
      </div>
      <div class="analysis-stats">
        <span class="stat">
          <i class="bi bi-check-circle text-success"></i>
          {{ filteredItemAnalysis | aiAnalyzedCount }} / {{ filteredItemAnalysis.length }} AI Analyzed
        </span>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoadingItems">
      <div class="spinner"></div>
      <p>Analyzing items across all vendors...</p>
    </div>

    <!-- Empty State -->
    <div class="empty-items" *ngIf="!isLoadingItems && filteredItemAnalysis.length === 0">
      <i class="bi bi-inbox"></i>
      <p *ngIf="itemSearchQuery">No items found matching "{{ itemSearchQuery }}"</p>
      <p *ngIf="!itemSearchQuery">No purchase data available. Create purchase orders to see item analysis.</p>
    </div>

    <!-- Item Analysis Table -->
    <div class="item-analysis-content" *ngIf="!isLoadingItems && filteredItemAnalysis.length > 0">
      <!-- Summary Cards -->
      <div class="analysis-summary">
        <div class="summary-card">
          <i class="bi bi-box-seam"></i>
          <div class="summary-info">
            <span class="summary-value">{{ filteredItemAnalysis.length }}</span>
            <span class="summary-label">Unique Items</span>
          </div>
        </div>
        <div class="summary-card">
          <i class="bi bi-building"></i>
          <div class="summary-info">
            <span class="summary-value">{{ vendors.length }}</span>
            <span class="summary-label">Vendors</span>
          </div>
        </div>
        <div class="summary-card highlight">
          <i class="bi bi-lightbulb"></i>
          <div class="summary-info">
            <span class="summary-value">{{ getMultiVendorItemCount() }}</span>
            <span class="summary-label">Multi-Vendor Items</span>
          </div>
        </div>
        <div class="summary-card ai-card">
          <i class="bi bi-cpu"></i>
          <div class="summary-info">
            <span class="summary-value">{{ filteredItemAnalysis | aiAnalyzedCount }}</span>
            <span class="summary-label">AI Analyzed</span>
          </div>
        </div>
      </div>

      <!-- Items Table - Enhanced with AI columns -->
      <div class="items-table-container">
        <table class="items-analysis-table">
          <thead>
            <tr>
              <th class="col-rank">#</th>
              <th class="col-item">Item</th>
              <th class="col-category">Category</th>
              <th class="col-score">AI Score</th>
              <th class="col-risk">Risk Level</th>
              <th class="col-buy-from">ðŸ›’ Buy From</th>
              <th class="col-price">Avg Price</th>
              <th class="col-stability">Price Stability</th>
              <th class="col-vendors">Vendors</th>
              <th class="col-demand">Demand Trend</th>
              <th class="col-supply">Supply Risk</th>
              <th class="col-purchases">Purchases</th>
              <th class="col-actions">Details</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let item of filteredItemAnalysis; let i = index">
              <!-- Main Item Row -->
              <tr [class.top-performer]="i < 3 && item.aiScore && item.aiScore >= 75"
                  [class.selected]="selectedItemForDetail?.itemName === item.itemName"
                  [class.expanded]="isItemExpanded(item)"
                  (click)="selectItemForDetail(item)">
                <td class="col-rank">
                  <span class="rank-badge" [class.gold]="i === 0" [class.silver]="i === 1" [class.bronze]="i === 2">
                    {{ i + 1 }}
                  </span>
                </td>
                <td class="col-item">
                  <div class="item-name-cell">
                    <div class="item-name-row">
                      <!-- Expand button - only show if more than 1 vendor -->
                      <button class="expand-btn" 
                              *ngIf="item.vendorOptions.length > 1"
                              (click)="toggleItemExpand(item, $event)"
                              [title]="isItemExpanded(item) ? 'Collapse vendors' : 'Show all ' + item.vendorOptions.length + ' vendors'">
                        <i class="bi" [ngClass]="isItemExpanded(item) ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
                      </button>
                      <span class="no-expand-spacer" *ngIf="item.vendorOptions.length <= 1"></span>
                      <span class="item-name">{{ item.itemName }}</span>
                      <span class="item-code" *ngIf="item.itemCode">{{ item.itemCode }}</span>
                      <span class="top-badge" *ngIf="i < 3 && (item.aiScore && item.aiScore >= 70 || (!item.aiScore && calculateItemScore(item) >= 70))">
                        <i class="bi bi-trophy-fill"></i> Top Performer
                      </span>
                      <span class="recommended-badge" *ngIf="item.aiRiskLevel === 'low' || (!item.aiRiskLevel && item.recommendedVendor && item.recommendedVendor.riskScore <= 20)">
                        <i class="bi bi-check-circle-fill"></i> Recommended
                      </span>
                    </div>
                    <span class="item-qty">
                      {{ item.totalQuantity }} units purchased | 
                      {{ item.vendorOptions.length }} vendor{{ item.vendorOptions.length > 1 ? 's available' : ' available' }}
                      <span class="no-vendor-warning" *ngIf="item.vendorOptions.length === 0">
                        <i class="bi bi-exclamation-triangle-fill"></i> No vendors mapped
                      </span>
                    </span>
                  </div>
                </td>
                <td class="col-category">
                  <span class="category-badge">{{ item.category || 'General' }}</span>
                </td>
                <td class="col-score">
                  <div class="score-cell" *ngIf="item.aiAnalyzed">
                    <span class="ai-score" [ngClass]="getScoreClass(item.aiScore || 0)">
                      {{ item.aiScore }}
                    </span>
                    <i class="bi bi-stars ai-badge" title="AI Analyzed"></i>
                  </div>
                  <div class="score-cell" *ngIf="!item.aiAnalyzed">
                    <span class="calculated-score">{{ calculateItemScore(item) }}</span>
                    <span class="pending-ai" title="Run AI analysis for accurate score">
                      <i class="bi bi-hourglass-split"></i>
                    </span>
                  </div>
                </td>
                <td class="col-risk">
                  <span class="risk-level-badge" 
                        [ngClass]="'risk-' + (item.aiRiskLevel || (item.recommendedVendor ? getItemRiskClass(item.recommendedVendor.riskScore).replace('risk-', '') : 'medium'))">
                    {{ item.aiRiskLevel || (item.recommendedVendor ? getRiskLabel(item.recommendedVendor.riskScore) : 'N/A') }}
                  </span>
                </td>
                <!-- Prominent Buy From Column -->
                <td class="col-buy-from">
                  <div class="buy-from-cell" *ngIf="item.recommendedVendor">
                    <div class="vendor-recommendation">
                      <span class="vendor-avatar" [style.background-color]="getVendorColor(item.recommendedVendor.vendorName)">
                        {{ item.recommendedVendor.vendorName.charAt(0) }}
                      </span>
                      <div class="vendor-info">
                        <span class="vendor-name-highlight">{{ item.recommendedVendor.vendorName }}</span>
                        <span class="vendor-metrics-mini">
                          <i class="bi bi-star-fill text-warning"></i> {{ item.recommendedVendor.qualityScore }}%
                          <span class="separator">|</span>
                          {{ formatCurrency(item.recommendedVendor.avgPrice) }}
                        </span>
                      </div>
                      <span class="best-choice-badge" *ngIf="item.aiAnalyzed || item.recommendedVendor.riskScore <= 20">
                        <i class="bi bi-check-circle-fill"></i>
                      </span>
                    </div>
                  </div>
                  <span class="no-vendor" *ngIf="!item.recommendedVendor">-</span>
                </td>
                <td class="col-price">
                  {{ formatCurrency(item.avgPrice) }}
                </td>
                <td class="col-stability">
                  <div class="stability-indicator">
                    <div class="stability-bar">
                      <div class="stability-fill" [style.width.%]="item.priceStability || 50"></div>
                    </div>
                    <span>{{ item.priceStability || 50 }}%</span>
                  </div>
                </td>
                <td class="col-vendors">
                  <span class="vendor-count" [class.single-vendor]="item.vendorOptions.length === 1">
                    {{ item.vendorOptions.length }}
                    <i class="bi bi-exclamation-triangle-fill" *ngIf="item.vendorOptions.length === 1" title="Single source risk"></i>
                  </span>
                </td>
                <td class="col-demand">
                  <span class="trend-indicator" [ngClass]="getTrendClass(item.demandTrend)">
                    <i [class]="getTrendIcon(item.demandTrend)"></i>
                    {{ item.demandTrend || 'Stable' }}
                  </span>
                </td>
                <td class="col-supply">
                  <span class="supply-risk" [ngClass]="{
                    'low': (item.supplyChainRisk || 50) < 30,
                    'medium': (item.supplyChainRisk || 50) >= 30 && (item.supplyChainRisk || 50) < 60,
                    'high': (item.supplyChainRisk || 50) >= 60
                  }">
                    {{ item.supplyChainRisk || 50 }}%
                  </span>
                </td>
                <td class="col-purchases">
                  <span class="purchase-count">{{ item.totalPurchases }}</span>
                </td>
                <td class="col-actions">
                  <div class="action-buttons">
                    <!-- Compare Vendors Button - shown for items with 2+ vendors -->
                    <button 
                      class="btn-compare-inline" 
                      *ngIf="item.vendorOptions.length >= 2"
                      (click)="analyzeItemVendorComparison(item); $event.stopPropagation()"
                      [disabled]="isAnalyzingVendorComparison"
                      title="Compare {{ item.vendorOptions.length }} vendors and get AI recommendation"
                    >
                      <i class="bi bi-diagram-3"></i>
                      <span class="compare-text">Compare</span>
                    </button>
                    <!-- View Details Button -->
                    <button class="btn-icon" title="View Details">
                      <i class="bi" [ngClass]="selectedItemForDetail?.itemName === item.itemName ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                    </button>
                  </div>
                </td>
              </tr>
              
              <!-- Expanded Vendors Row - shows alternate vendors with priority -->
              <tr class="expanded-vendors-row" *ngIf="isItemExpanded(item) && item.vendorOptions.length > 1">
                <td colspan="13">
                  <div class="alternate-vendors-container">
                    <div class="alternate-vendors-header">
                      <i class="bi bi-diagram-3"></i>
                      <span>Alternative Vendors (Priority Order)</span>
                      <span class="vendor-count-badge">{{ item.vendorOptions.length - 1 }} alternative{{ item.vendorOptions.length > 2 ? 's' : '' }}</span>
                    </div>
                    <div class="alternate-vendors-grid">
                      <div class="alternate-vendor-card" 
                           *ngFor="let vendor of getAlternateVendors(item); let priority = index"
                           [ngClass]="getItemRiskClass(vendor.riskScore)">
                        <div class="priority-badge">
                          <span class="priority-number">#{{ priority + 2 }}</span>
                          <span class="priority-label">Priority</span>
                        </div>
                        <div class="vendor-card-header">
                          <span class="vendor-avatar-small" [style.background-color]="getVendorColor(vendor.vendorName)">
                            {{ vendor.vendorName.charAt(0) }}
                          </span>
                          <div class="vendor-card-name">
                            <span class="name">{{ vendor.vendorName }}</span>
                            <span class="preferred-tag" *ngIf="vendor.isPreferred">
                              <i class="bi bi-star-fill"></i> Preferred
                            </span>
                          </div>
                        </div>
                        <div class="vendor-card-metrics">
                          <div class="metric">
                            <span class="metric-label">Price</span>
                            <span class="metric-value">{{ formatCurrency(vendor.avgPrice) }}</span>
                          </div>
                          <div class="metric">
                            <span class="metric-label">Quality</span>
                            <span class="metric-value">{{ vendor.qualityScore }}%</span>
                          </div>
                          <div class="metric">
                            <span class="metric-label">On-Time</span>
                            <span class="metric-value">{{ vendor.onTimeDeliveryRate }}%</span>
                          </div>
                          <div class="metric">
                            <span class="metric-label">Lead Time</span>
                            <span class="metric-value">{{ vendor.leadTimeDays || '-' }} days</span>
                          </div>
                          <div class="metric">
                            <span class="metric-label">Risk</span>
                            <span class="metric-value" [ngClass]="getItemRiskClass(vendor.riskScore)">
                              {{ vendor.riskScore }}%
                            </span>
                          </div>
                          <div class="metric" *ngIf="vendor.minOrderQuantity">
                            <span class="metric-label">Min Order</span>
                            <span class="metric-value">{{ vendor.minOrderQuantity }}</span>
                          </div>
                        </div>
                        <div class="vendor-card-footer">
                          <span class="risk-badge" [ngClass]="getItemRiskClass(vendor.riskScore)">
                            {{ getRiskLabel(vendor.riskScore) }}
                          </span>
                          <span class="price-diff" *ngIf="item.recommendedVendor">
                            <ng-container *ngIf="vendor.avgPrice > item.recommendedVendor.avgPrice">
                              <i class="bi bi-arrow-up text-danger"></i>
                              +{{ formatCurrency(vendor.avgPrice - item.recommendedVendor.avgPrice) }}
                            </ng-container>
                            <ng-container *ngIf="vendor.avgPrice < item.recommendedVendor.avgPrice">
                              <i class="bi bi-arrow-down text-success"></i>
                              -{{ formatCurrency(item.recommendedVendor.avgPrice - vendor.avgPrice) }}
                            </ng-container>
                            <ng-container *ngIf="vendor.avgPrice === item.recommendedVendor.avgPrice">
                              <i class="bi bi-dash"></i> Same price
                            </ng-container>
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>

      <!-- Selected Item Detail Panel -->
      <div class="item-detail-panel" *ngIf="selectedItemForDetail">
        <div class="detail-header">
          <h3>
            <i class="bi bi-box-seam"></i>
            {{ selectedItemForDetail.itemName }}
          </h3>
          <button class="close-detail" (click)="selectedItemForDetail = null">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>

        <div class="detail-content">
          <!-- AI Insights Section -->
          <div class="ai-insights-section" *ngIf="selectedItemForDetail.aiAnalyzed">
            <h4><i class="bi bi-stars"></i> AI Analysis Results</h4>
            <div class="ai-result-summary">
              <div class="ai-result-card">
                <span class="result-label">AI Score</span>
                <span class="result-value" [ngClass]="getScoreClass(selectedItemForDetail.aiScore || 0)">
                  {{ selectedItemForDetail.aiScore }}/100
                </span>
              </div>
              <div class="ai-result-card">
                <span class="result-label">Risk Level</span>
                <span class="result-value risk-level-badge" [ngClass]="'risk-' + selectedItemForDetail.aiRiskLevel">
                  {{ selectedItemForDetail.aiRiskLevel }}
                </span>
              </div>
            </div>
            <div class="ai-insights-list" *ngIf="selectedItemForDetail.aiInsights && selectedItemForDetail.aiInsights.length > 0">
              <h5>Key Insights</h5>
              <ul>
                <li *ngFor="let insight of selectedItemForDetail.aiInsights">
                  <i class="bi bi-lightbulb"></i>
                  {{ insight }}
                </li>
              </ul>
            </div>
            <div class="ai-recommendation" *ngIf="selectedItemForDetail.aiRecommendation">
              <h5><i class="bi bi-arrow-right-circle"></i> Recommendation</h5>
              <p>{{ selectedItemForDetail.aiRecommendation }}</p>
            </div>
          </div>

          <!-- Not AI Analyzed Yet -->
          <div class="no-ai-section" *ngIf="!selectedItemForDetail.aiAnalyzed">
            <i class="bi bi-cpu"></i>
            <p>AI analysis not yet performed for this item.</p>
            <button class="btn btn-primary btn-sm" (click)="analyzeSingleItem(selectedItemForDetail)" [disabled]="isAnalyzingItems">
              <span *ngIf="!isAnalyzingItems"><i class="bi bi-stars"></i> Analyze This Item</span>
              <span *ngIf="isAnalyzingItems"><div class="spinner-sm"></div> Analyzing...</span>
            </button>
          </div>

          <!-- Vendor Comparison Button (for items with multiple vendors) -->
          <div class="vendor-comparison-action" *ngIf="selectedItemForDetail.vendorOptions.length >= 2">
            <button 
              class="btn btn-vendor-compare"
              (click)="analyzeItemVendorComparison(selectedItemForDetail)"
              [disabled]="isAnalyzingVendorComparison"
            >
              <span *ngIf="!isAnalyzingVendorComparison">
                <i class="bi bi-diagram-3"></i> 
                Compare {{ selectedItemForDetail.vendorOptions.length }} Vendors - Which Should I Buy From?
              </span>
              <span *ngIf="isAnalyzingVendorComparison">
                <div class="spinner-sm"></div> Analyzing Vendors...
              </span>
            </button>
            <p class="comparison-hint">
              <i class="bi bi-info-circle"></i>
              AI will analyze all {{ selectedItemForDetail.vendorOptions.length }} vendors and recommend the best choice based on price, quality, delivery, and reliability.
            </p>
          </div>

          <!-- Recommended Vendor -->
          <div class="recommended-vendor-section" *ngIf="selectedItemForDetail.recommendedVendor">
            <h4><i class="bi bi-award"></i> Recommended Vendor</h4>
            <div class="recommended-vendor-card">
              <div class="vendor-name">
                <span class="avatar">{{ selectedItemForDetail.recommendedVendor.vendorName.charAt(0) }}</span>
                <span>{{ selectedItemForDetail.recommendedVendor.vendorName }}</span>
              </div>
              <div class="vendor-metrics-grid">
                <div class="metric">
                  <span class="metric-label">Quality</span>
                  <span class="metric-value">{{ selectedItemForDetail.recommendedVendor.qualityScore }}%</span>
                </div>
                <div class="metric">
                  <span class="metric-label">On-Time Delivery</span>
                  <span class="metric-value">{{ selectedItemForDetail.recommendedVendor.onTimeDeliveryRate }}%</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Avg Price</span>
                  <span class="metric-value">{{ formatCurrency(selectedItemForDetail.recommendedVendor.avgPrice) }}</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Risk Score</span>
                  <span class="metric-value" [ngClass]="getItemRiskClass(selectedItemForDetail.recommendedVendor.riskScore)">
                    {{ selectedItemForDetail.recommendedVendor.riskScore }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- All Vendor Options Table -->
          <div class="vendor-options-section" *ngIf="selectedItemForDetail.vendorOptions.length > 1">
            <h4><i class="bi bi-building"></i> All Vendor Options</h4>
            <table class="vendor-comparison-table">
              <thead>
                <tr>
                  <th>Vendor</th>
                  <th>Avg Price</th>
                  <th>Quality</th>
                  <th>On-Time</th>
                  <th>Reliability</th>
                  <th>Price Variance</th>
                  <th>Risk Score</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let vendor of selectedItemForDetail.vendorOptions" [class.recommended-row]="vendor.isRecommended">
                  <td class="vendor-cell">
                    <span class="vendor-avatar">{{ vendor.vendorName.charAt(0) }}</span>
                    <span>{{ vendor.vendorName }}</span>
                    <i class="bi bi-check-circle-fill recommended-icon" *ngIf="vendor.isRecommended" title="Recommended"></i>
                  </td>
                  <td>{{ formatCurrency(vendor.avgPrice) }}</td>
                  <td>
                    <span class="quality-badge" [ngClass]="{'high': vendor.qualityScore >= 80, 'medium': vendor.qualityScore >= 60 && vendor.qualityScore < 80, 'low': vendor.qualityScore < 60}">
                      {{ vendor.qualityScore }}%
                    </span>
                  </td>
                  <td>
                    <span class="delivery-badge" [ngClass]="{'high': vendor.onTimeDeliveryRate >= 90, 'medium': vendor.onTimeDeliveryRate >= 70 && vendor.onTimeDeliveryRate < 90, 'low': vendor.onTimeDeliveryRate < 70}">
                      {{ vendor.onTimeDeliveryRate }}%
                    </span>
                  </td>
                  <td>{{ vendor.reliabilityScore || 'N/A' }}</td>
                  <td>{{ vendor.priceVariance?.toFixed(1) || 'N/A' }}%</td>
                  <td>
                    <span class="risk-score" [ngClass]="getItemRiskClass(vendor.riskScore)">
                      {{ vendor.riskScore }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Single Vendor Warning -->
          <div class="single-vendor-warning" *ngIf="selectedItemForDetail.vendorOptions.length === 1">
            <i class="bi bi-exclamation-triangle"></i>
            <div>
              <strong>Single Source Risk</strong>
              <p>This item is only available from one vendor. Consider qualifying additional suppliers to reduce supply chain risk.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- API Key Modal -->
  <div
    class="modal-overlay"
    *ngIf="showApiKeyModal"
    (click)="showApiKeyModal = false"
  >
    <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3><i class="bi bi-key"></i> Configure AI Provider</h3>
        <button class="close-btn" (click)="showApiKeyModal = false">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <div class="modal-body">
        <!-- Gemini Section (FREE) -->
        <div class="provider-section recommended">
          <div class="provider-header">
            <div class="provider-title">
              <i class="bi bi-stars"></i>
              <h4>Google Gemini</h4>
              <span class="free-badge">FREE</span>
            </div>
            <span class="provider-status" [class.configured]="hasGeminiKey">
              {{ hasGeminiKey ? "âœ“ Configured" : "Not configured" }}
            </span>
          </div>
          <p class="provider-description">
            Get a FREE API key from Google AI Studio. Generous free tier with 60
            requests/minute.
          </p>
          <a
            href="https://makersuite.google.com/app/apikey"
            target="_blank"
            class="get-key-link"
          >
            <i class="bi bi-box-arrow-up-right"></i> Get FREE Gemini API Key
          </a>
          <div class="form-group">
            <input
              type="password"
              class="form-input"
              [(ngModel)]="geminiKeyInput"
              placeholder="AIza..."
            />
            <button
              class="btn btn-success btn-sm"
              (click)="setGeminiKey()"
              [disabled]="!geminiKeyInput.trim()"
            >
              Save Gemini Key
            </button>
          </div>
        </div>

        <div class="divider-or">
          <span>OR</span>
        </div>

        <!-- OpenAI Section (Paid) -->
        <div class="provider-section">
          <div class="provider-header">
            <div class="provider-title">
              <i class="bi bi-lightning"></i>
              <h4>OpenAI</h4>
              <span class="paid-badge">Paid</span>
            </div>
            <span class="provider-status" [class.configured]="hasApiKey">
              {{ hasApiKey ? "âœ“ Configured" : "Not configured" }}
            </span>
          </div>
          <p class="provider-description">
            Requires credits. Better for production use with higher rate limits.
          </p>
          <div class="form-group">
            <input
              type="password"
              class="form-input"
              [(ngModel)]="apiKeyInput"
              placeholder="sk-..."
            />
            <button
              class="btn btn-primary btn-sm"
              (click)="setApiKey()"
              [disabled]="!apiKeyInput.trim()"
            >
              Save OpenAI Key
            </button>
          </div>
        </div>

        <div class="api-info">
          <i class="bi bi-shield-check"></i>
          <span
            >Your API keys are stored locally in your browser and never sent to
            our servers.</span
          >
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="showApiKeyModal = false">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Vendor Comparison Modal -->
  <div class="modal-overlay" *ngIf="showVendorComparisonModal" (click)="closeVendorComparisonModal()">
    <div class="modal-content vendor-comparison-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <i class="bi bi-diagram-3"></i>
          Vendor Comparison Analysis
        </h2>
        <button class="close-btn" (click)="closeVendorComparisonModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <!-- Loading State -->
        <div class="comparison-loading" *ngIf="isAnalyzingVendorComparison && !vendorComparisonResult">
          <div class="spinner"></div>
          <p>Analyzing vendors and generating recommendations...</p>
          <small>This may take a few seconds</small>
        </div>
        
        <!-- Results -->
        <div class="comparison-results" *ngIf="vendorComparisonResult">
          <!-- Item Info Header -->
          <div class="comparison-header">
            <div class="item-info">
              <h3>{{ vendorComparisonResult.itemName }}</h3>
              <span class="category-badge">{{ vendorComparisonResult.category }}</span>
              <span class="vendor-count">{{ vendorComparisonResult.totalVendors }} vendors compared</span>
            </div>
          </div>
          
          <!-- Best Choice Highlights -->
          <div class="best-choices-grid">
            <div class="best-choice-card best-overall" *ngIf="vendorComparisonResult.bestChoice">
              <div class="choice-label">
                <i class="bi bi-trophy"></i> Best Overall
              </div>
              <div class="choice-vendor">{{ vendorComparisonResult.bestChoice.vendorName }}</div>
              <div class="choice-score">Score: {{ vendorComparisonResult.bestChoice.overallScore }}/100</div>
            </div>
            
            <div class="best-choice-card best-value" *ngIf="vendorComparisonResult.bestValue">
              <div class="choice-label">
                <i class="bi bi-cash-stack"></i> Best Value
              </div>
              <div class="choice-vendor">{{ vendorComparisonResult.bestValue.vendorName }}</div>
              <div class="choice-score">{{ formatCostSavings(vendorComparisonResult.bestValue.costSavingsVsAvg) }}</div>
            </div>
            
            <div class="best-choice-card best-quality" *ngIf="vendorComparisonResult.bestQuality">
              <div class="choice-label">
                <i class="bi bi-award"></i> Best Quality
              </div>
              <div class="choice-vendor">{{ vendorComparisonResult.bestQuality.vendorName }}</div>
              <div class="choice-score">Quality: {{ vendorComparisonResult.bestQuality.scores.quality }}%</div>
            </div>
            
            <div class="best-choice-card most-reliable" *ngIf="vendorComparisonResult.mostReliable">
              <div class="choice-label">
                <i class="bi bi-clock-history"></i> Most Reliable
              </div>
              <div class="choice-vendor">{{ vendorComparisonResult.mostReliable.vendorName }}</div>
              <div class="choice-score">Delivery: {{ vendorComparisonResult.mostReliable.scores.delivery }}%</div>
            </div>
          </div>
          
          <!-- Vendor Comparison Table -->
          <div class="vendor-comparison-section">
            <h4><i class="bi bi-list-columns-reverse"></i> Detailed Vendor Comparison</h4>
            <div class="comparison-table-wrapper">
              <table class="vendor-comparison-table-detailed">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Vendor</th>
                    <th>Overall Score</th>
                    <th>Price</th>
                    <th>Quality</th>
                    <th>Delivery</th>
                    <th>Reliability</th>
                    <th>Cost vs Avg</th>
                    <th>Verdict</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let vendor of vendorComparisonResult.vendorComparisons" [class.recommended-row]="vendor.isRecommended">
                    <td>
                      <span class="rank-badge" [ngClass]="getRankBadgeClass(vendor.rank)">#{{ vendor.rank }}</span>
                    </td>
                    <td>
                      <div class="vendor-cell">
                        <span class="vendor-avatar" [style.background]="getVendorColor(vendor.vendorName)">
                          {{ vendor.vendorName.charAt(0) }}
                        </span>
                        <span class="vendor-name">{{ vendor.vendorName }}</span>
                        <span class="recommended-tag" *ngIf="vendor.isRecommended">âœ“ Recommended</span>
                      </div>
                    </td>
                    <td>
                      <div class="score-bar">
                        <div class="score-fill" [style.width.%]="vendor.overallScore" [ngClass]="getVendorScoreClass(vendor.overallScore)"></div>
                        <span class="score-value">{{ vendor.overallScore }}</span>
                      </div>
                    </td>
                    <td>
                      <span class="metric-score" [ngClass]="getVendorScoreClass(vendor.scores.price)">{{ vendor.scores.price }}</span>
                    </td>
                    <td>
                      <span class="metric-score" [ngClass]="getVendorScoreClass(vendor.scores.quality)">{{ vendor.scores.quality }}</span>
                    </td>
                    <td>
                      <span class="metric-score" [ngClass]="getVendorScoreClass(vendor.scores.delivery)">{{ vendor.scores.delivery }}</span>
                    </td>
                    <td>
                      <span class="metric-score" [ngClass]="getVendorScoreClass(vendor.scores.reliability)">{{ vendor.scores.reliability }}</span>
                    </td>
                    <td>
                      <span class="savings-badge" [ngClass]="getSavingsClass(vendor.costSavingsVsAvg)">
                        {{ formatCostSavings(vendor.costSavingsVsAvg) }}
                      </span>
                    </td>
                    <td class="verdict-cell">
                      <span class="verdict-text">{{ vendor.aiVerdict }}</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Pros and Cons Section -->
          <div class="pros-cons-section">
            <h4><i class="bi bi-list-check"></i> Vendor Pros & Cons</h4>
            <div class="pros-cons-grid">
              <div class="vendor-pros-cons" *ngFor="let vendor of vendorComparisonResult.vendorComparisons">
                <div class="vendor-header" [class.is-recommended]="vendor.isRecommended">
                  <span class="vendor-avatar-sm" [style.background]="getVendorColor(vendor.vendorName)">
                    {{ vendor.vendorName.charAt(0) }}
                  </span>
                  <span>{{ vendor.vendorName }}</span>
                  <span class="rank-sm" [ngClass]="getRankBadgeClass(vendor.rank)">#{{ vendor.rank }}</span>
                </div>
                <div class="pros-list">
                  <div class="list-label"><i class="bi bi-check-circle text-success"></i> Pros</div>
                  <ul>
                    <li *ngFor="let pro of vendor.pros">{{ pro }}</li>
                  </ul>
                </div>
                <div class="cons-list">
                  <div class="list-label"><i class="bi bi-x-circle text-danger"></i> Cons</div>
                  <ul>
                    <li *ngFor="let con of vendor.cons">{{ con }}</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Recommendations Section -->
          <div class="recommendations-section">
            <div class="recommendation-card main-recommendation">
              <h4><i class="bi bi-lightbulb"></i> Overall Recommendation</h4>
              <p>{{ vendorComparisonResult.overallRecommendation }}</p>
            </div>
            
            <div class="recommendation-card strategy">
              <h4><i class="bi bi-diagram-2"></i> Procurement Strategy</h4>
              <p>{{ vendorComparisonResult.procurementStrategy }}</p>
            </div>
            
            <div class="recommendation-grid">
              <div class="recommendation-card risk-mitigation">
                <h4><i class="bi bi-shield-check"></i> Risk Mitigation</h4>
                <ul>
                  <li *ngFor="let item of vendorComparisonResult.riskMitigation">{{ item }}</li>
                </ul>
              </div>
              
              <div class="recommendation-card cost-optimization">
                <h4><i class="bi bi-graph-down-arrow"></i> Cost Optimization</h4>
                <ul>
                  <li *ngFor="let item of vendorComparisonResult.costOptimization">{{ item }}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeVendorComparisonModal()">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
