<div class="add-vendor-container">
  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="pageLoading">
    <div class="spinner-wrapper">
      <div class="spinner"></div>
      <p>Loading...</p>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-wrapper" *ngIf="!pageLoading">
    <!-- Header Card -->
    <div class="header-card">
      <div class="header-content">
        <h5 class="card-title">
          <i class="bi bi-person-plus-fill"></i>
          {{ isEditMode ? "Edit Supplier" : "Add New Supplier" }}
        </h5>
        <nav class="breadcrumb-nav">
          <a routerLink="/dashboard" class="breadcrumb-item">
            <i class="bi bi-house"></i> Home
          </a>
          <i class="bi bi-chevron-right separator"></i>
          <a routerLink="/vendors" class="breadcrumb-item">Vendors</a>
          <i class="bi bi-chevron-right separator"></i>
          <span class="breadcrumb-item active">{{
            isEditMode ? "Edit" : "Add New"
          }}</span>
        </nav>
      </div>
    </div>

    <!-- Supplier Details Form Card -->
    <div class="form-card">
      <div class="card-header">
        <h4>
          <i class="bi bi-clipboard-data"></i>
          Supplier Details Form
        </h4>
      </div>
      <div class="card-body">
        <form [formGroup]="supplierForm">
          <div class="form-row">
            <!-- Vendor Name -->
            <div class="form-group">
              <label class="form-label">
                Vendor Name <span class="required">*</span>
              </label>
              <div class="input-wrapper">
                <i class="bi bi-building input-icon"></i>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Enter Vendor Name"
                  formControlName="vendorName"
                  [class.is-invalid]="
                    getFormControl['vendorName'].touched &&
                    getFormControl['vendorName'].errors
                  "
                />
              </div>
              <small
                class="error-text"
                *ngIf="
                  getFormControl['vendorName'].touched &&
                  getFormControl['vendorName'].errors
                "
              >
                <span *ngIf="getFormControl['vendorName'].errors?.['required']">
                  <i class="bi bi-exclamation-circle"></i> Vendor name is
                  required.
                </span>
                <span
                  *ngIf="getFormControl['vendorName'].errors?.['minlength']"
                >
                  <i class="bi bi-exclamation-circle"></i> Minimum 3 characters.
                </span>
              </small>

              <div class="mt-3">
                <label class="form-label">Contact Person</label>
                <div class="input-wrapper">
                  <i class="bi bi-person input-icon"></i>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Enter Contact Person"
                    formControlName="contactPerson"
                  />
                </div>
              </div>

              <div class="mt-3">
                <label class="form-label">Email</label>
                <div class="input-wrapper">
                  <i class="bi bi-envelope input-icon"></i>
                  <input
                    type="email"
                    class="form-control"
                    placeholder="Enter Email"
                    formControlName="email"
                  />
                </div>
              </div>

              <div class="mt-3">
                <label class="form-label">Phone</label>
                <div class="input-wrapper">
                  <i class="bi bi-telephone input-icon"></i>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Enter Phone"
                    formControlName="phone"
                  />
                </div>
              </div>
            </div>

            <!-- Right Column -->
            <div class="form-group">
              <label class="form-label">Category</label>
              <div class="select-wrapper">
                <i class="bi bi-tag select-icon"></i>
                <select class="form-control" formControlName="category">
                  <option value="General">General</option>
                  <option value="Electronics">Electronics</option>
                  <option value="Office Supplies">Office Supplies</option>
                  <option value="IT Services">IT Services</option>
                  <option value="Raw Materials">Raw Materials</option>
                  <option value="Logistics">Logistics</option>
                  <option value="Manufacturing">Manufacturing</option>
                </select>
              </div>

              <div class="mt-3">
                <label class="form-label">Status</label>
                <div class="select-wrapper">
                  <i class="bi bi-toggle-on select-icon"></i>
                  <select class="form-control" formControlName="status">
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="pending">Pending</option>
                    <option value="suspended">Suspended</option>
                  </select>
                </div>
              </div>

              <!-- <div class="mt-3">
                <label class="form-label">Address</label>
                <div class="input-wrapper">
                  <i class="bi bi-geo-alt input-icon"></i>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Enter Address"
                    formControlName="address"
                  />
                </div> -->


              <div class="mt-3">
                <label class="form-label">City</label>
                <div class="input-wrapper">
                  <i class="bi bi-geo input-icon"></i>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Enter City"
                    formControlName="city"
                  />
                </div>
              </div>

              <div class="mt-3">
                <label class="form-label">Country</label>
                <div class="input-wrapper">
                  <i class="bi bi-globe input-icon"></i>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Enter Country"
                    formControlName="country"
                  />
                </div>
              </div>

              <!-- <div class="mt-3"> -->
                <!-- <label class="form-label">Payment Terms</label>
                <div class="select-wrapper">
                  <i class="bi bi-credit-card select-icon"></i>
                  <select class="form-control" formControlName="paymentTerms">
                    <option value="Net 15">Net 15</option>
                    <option value="Net 30">Net 30</option>
                    <option value="Net 45">Net 45</option>
                    <option value="Net 60">Net 60</option>
                  </select>
                </div>
              </div> -->
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Tabs Card -->
    <div class="tabs-card">
      <!-- Tab Navigation -->
      <div class="tabs-nav">
        <button
          class="tab-btn"
          [class.active]="activeTab === '0'"
          (click)="onTabChange('0')"
        >
          <i class="bi bi-wallet2"></i>
          Op.Balance
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab === '2'"
          (click)="onTabChange('2')"
        >
          <i class="bi bi-bullseye"></i>
          Cost Centers
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab === '3'"
          (click)="onTabChange('3')"
        >
          <i class="bi bi-file-earmark-text"></i>
          Documents
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab === '4'"
          (click)="onTabChange('4')"
        >
          <i class="bi bi-people"></i>
          Users
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tabs-content">
        <!-- Op.Balance Tab -->
        <div class="tab-panel" *ngIf="activeTab === '0'">
          <div class="panel-header">
            <h5>Opening Balance</h5>
            <button class="btn-add" (click)="handleOpBalanceDialog()">
              <i class="bi bi-plus-lg"></i>
              Add Entry
            </button>
          </div>

          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th *ngFor="let header of opBalanceTableHeader">
                    {{ header }}
                  </th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let opBalance of opBalanceData; let i = index">
                  <td>{{ opBalance.referenceDate }}</td>
                  <td>{{ opBalance.reference }}</td>
                  <td>{{ opBalance.chequeNo }}</td>
                  <td class="number-cell">
                    {{ opBalance.debit | number : "1.2-2" }}
                  </td>
                  <td class="number-cell">
                    {{ opBalance.credit | number : "1.2-2" }}
                  </td>
                  <td class="number-cell">{{ opBalance.exchangeRate }}</td>
                  <td>{{ opBalance.dueDate }}</td>
                  <td class="actions-cell">
                    <button
                      class="btn-icon edit"
                      (click)="handleEditBalance(i)"
                      title="Edit"
                      *ngIf="permissionData.canEdit"
                    >
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button
                      class="btn-icon delete"
                      (click)="handleDeleteOpBalance(i)"
                      title="Delete"
                      *ngIf="permissionData.canDelete"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr *ngIf="opBalanceData.length === 0">
                  <td colspan="8" class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p>No opening balance entries found</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Cost Centers Tab -->
        <div class="tab-panel" *ngIf="activeTab === '2'">
          <form [formGroup]="costCenterTabForm">
            <div class="cost-center-grid">
              <!-- Default Cost Centers -->
              <div class="cost-card">
                <div class="cost-card-header">
                  <span class="floating-label">Default Cost Centers</span>
                </div>
                <div class="cost-card-body">
                  <div class="cost-row">
                    <div class="cost-column category">
                      <label class="column-label">Category</label>
                      <span class="category-value">
                        <i class="bi bi-diagram-2"></i>
                        Branches
                      </span>
                    </div>
                    <div class="cost-column center">
                      <label class="column-label">Cost Center Name</label>
                      <div class="select-wrapper">
                        <select
                          class="form-control"
                          formControlName="costCenterName"
                        >
                          <option value="">Select Cost Center</option>
                          <option
                            *ngFor="let center of costCentersData"
                            [value]="center.costCenterName"
                          >
                            {{ center.costCenterName }}
                          </option>
                        </select>
                      </div>
                      <small
                        class="error-text"
                        *ngIf="
                          getCostCenterForm['costCenterName'].invalid &&
                          getCostCenterForm['costCenterName'].touched
                        "
                      >
                        <i class="bi bi-exclamation-circle"></i> Cost Center
                        selection is required
                      </small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Visible in Branches -->
              <div class="cost-card">
                <div class="cost-card-header">
                  <span class="floating-label">Visible in Branches</span>
                </div>
                <div class="cost-card-body">
                  <table class="branch-table">
                    <thead>
                      <tr>
                        <th>Branch Name</th>
                        <th>Visible</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let branch of branchesData; let i = index">
                        <td>
                          <i class="bi bi-geo-alt"></i>
                          {{ branch.branchName }}
                        </td>
                        <td class="checkbox-cell">
                          <label class="checkbox-wrapper">
                            <input
                              type="checkbox"
                              [(ngModel)]="branch.isVisible"
                              [ngModelOptions]="{ standalone: true }"
                            />
                            <span class="checkmark"></span>
                          </label>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </form>
        </div>

        <!-- Documents Tab -->
        <div class="tab-panel" *ngIf="activeTab === '3'">
          <div class="panel-header">
            <h5>Upload Documents</h5>
            <div class="upload-section">
              <input
                type="file"
                id="documentUpload"
                accept="application/pdf,.doc,.docx"
                (change)="handleFileSelect($event)"
                hidden
              />
              <button class="btn-upload" (click)="triggerFileInput()">
                <i class="bi bi-cloud-upload"></i>
                Upload Document
              </button>
            </div>
          </div>

          <div class="table-container" *ngIf="uploadedDocument.length > 0">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Document Name</th>
                  <th>Size (KB)</th>
                  <th>Uploaded Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let doc of uploadedDocument; let i = index">
                  <td>
                    <i class="bi bi-file-earmark-pdf text-danger"></i>
                    {{ doc.name }}
                  </td>
                  <td class="number-cell">{{ doc.size | number : "1.2-2" }}</td>
                  <td>{{ doc.uploadedOn | date : "medium" }}</td>
                  <td class="actions-cell">
                    <a
                      [href]="doc.docUrl"
                      target="_blank"
                      class="btn-icon view"
                      title="Download"
                    >
                      <i class="bi bi-download"></i>
                    </a>
                    <button
                      class="btn-icon delete"
                      (click)="deleteDocument(i)"
                      title="Delete"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="empty-state-box" *ngIf="uploadedDocument.length === 0">
            <i class="bi bi-folder2-open"></i>
            <p>No documents uploaded yet</p>
            <span>Click "Upload Document" to add files</span>
          </div>
        </div>

        <!-- Users Tab -->
        <div class="tab-panel" *ngIf="activeTab === '4'">
          <div class="panel-header">
            <h5>Assign Users</h5>
            <button class="btn-add" (click)="addUserRow()">
              <i class="bi bi-plus-lg"></i>
              Add User
            </button>
          </div>

          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th style="width: 80px">Sl No</th>
                  <th>Users</th>
                  <th style="width: 120px">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of users; let i = index">
                  <td class="number-cell">{{ i + 1 }}</td>
                  <td>
                    <select
                      class="form-control multi-select"
                      [(ngModel)]="user.selectedUsers"
                      [disabled]="!user.isEditing"
                      multiple
                    >
                      <option *ngFor="let u of userslist" [value]="u.value">
                        {{ u.key }}
                      </option>
                    </select>
                  </td>
                  <td class="actions-cell">
                    <button
                      class="btn-icon edit"
                      (click)="editUserRow(i)"
                      title="Edit"
                    >
                      <i
                        class="bi"
                        [ngClass]="user.isEditing ? 'bi-check-lg' : 'bi-pencil'"
                      ></i>
                    </button>
                    <button
                      class="btn-icon delete"
                      (click)="deleteUserRow(i)"
                      title="Delete"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr *ngIf="users.length === 0">
                  <td colspan="3" class="empty-state">
                    <i class="bi bi-people"></i>
                    <p>No users assigned yet</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn-cancel" (click)="returnToHome()">
          <i class="bi bi-x-lg"></i>
          Cancel
        </button>
        <button
          type="button"
          class="btn-submit"
          (click)="saveSupplierData()"
          *ngIf="
            (!isEditMode && permissionData.canAccess) ||
            (isEditMode && permissionData.canEdit)
          "
        >
          <i
            class="bi"
            [ngClass]="isEditMode ? 'bi-check2-circle' : 'bi-save'"
          ></i>
          {{ isEditMode ? "Update" : "Submit" }}
        </button>
      </div>
    </div>

    <!-- Op Balance Dialog -->
    <div
      class="dialog-overlay"
      *ngIf="isOpBalanceDialogVisible"
      (click)="handledDailogCancel()"
    >
      <div class="dialog-container" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <h4>
            <i class="bi bi-wallet2"></i>
            {{
              editingOpBalanceIndex !== null
                ? "Edit Op Balance"
                : "Add Op Balance"
            }}
          </h4>
          <button class="dialog-close" (click)="handledDailogCancel()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div class="dialog-body">
          <form [formGroup]="opBalanceForm">
            <div class="dialog-form-grid">
              <div class="form-group">
                <label class="form-label">Ref Date</label>
                <div class="input-wrapper">
                  <i class="bi bi-calendar input-icon"></i>
                  <input
                    type="date"
                    class="form-control"
                    formControlName="referenceDate"
                  />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Reference</label>
                <div class="input-wrapper">
                  <i class="bi bi-hash input-icon"></i>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Enter Reference"
                    formControlName="reference"
                  />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Chq No</label>
                <div class="input-wrapper">
                  <i class="bi bi-credit-card input-icon"></i>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Enter Cheque Number"
                    formControlName="chequeNo"
                  />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Debit</label>
                <div class="input-wrapper">
                  <i class="bi bi-dash-circle input-icon"></i>
                  <input
                    type="number"
                    class="form-control"
                    placeholder="Enter Debit"
                    formControlName="debit"
                  />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Credit</label>
                <div class="input-wrapper">
                  <i class="bi bi-plus-circle input-icon"></i>
                  <input
                    type="number"
                    class="form-control"
                    placeholder="Enter Credit"
                    formControlName="credit"
                  />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Exchange Rate</label>
                <div class="input-wrapper">
                  <i class="bi bi-currency-exchange input-icon"></i>
                  <input
                    type="number"
                    class="form-control"
                    placeholder="Enter Exchange Rate"
                    formControlName="exchangeRate"
                  />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Due Date</label>
                <div class="input-wrapper">
                  <i class="bi bi-calendar-check input-icon"></i>
                  <input
                    type="date"
                    class="form-control"
                    formControlName="dueDate"
                  />
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="dialog-footer">
          <button
            type="button"
            class="btn-cancel"
            (click)="handledDailogCancel()"
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn-submit"
            (click)="handleSaveOpBalance()"
          >
            {{ editingOpBalanceIndex !== null ? "Update" : "Save" }}
          </button>
        </div>
      </div>
    </div>

    <!-- Budget Dialog -->
    <div
      class="dialog-overlay"
      *ngIf="isBudgetDialogVisible"
      (click)="handleBudgetDialogCancel()"
    >
      <div
        class="dialog-container dialog-sm"
        (click)="$event.stopPropagation()"
      >
        <div class="dialog-header">
          <h4>
            <i class="bi bi-calculator"></i>
            {{
              selectedBudgetIndex !== null
                ? "Edit Budget Entry"
                : "Add Budget Entry"
            }}
          </h4>
          <button class="dialog-close" (click)="handleBudgetDialogCancel()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div class="dialog-body">
          <form [formGroup]="budgetForm">
            <div class="dialog-form-stack">
              <div class="form-group">
                <label class="form-label">Sl No</label>
                <input
                  type="number"
                  class="form-control"
                  placeholder="Enter Sl No"
                  formControlName="Slno"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Period Ending</label>
                <input
                  type="number"
                  class="form-control"
                  placeholder="Enter Period Ending"
                  formControlName="Periodending"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Amount</label>
                <input
                  type="number"
                  class="form-control"
                  placeholder="Enter Amount"
                  formControlName="Amount"
                />
              </div>
            </div>
          </form>
        </div>
        <div class="dialog-footer">
          <button
            type="button"
            class="btn-cancel"
            (click)="handleBudgetDialogCancel()"
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn-submit"
            (click)="handleSaveBudget()"
            [disabled]="!budgetForm.valid"
          >
            {{ selectedBudgetIndex !== null ? "Update" : "Save" }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
